-include ../../run-make-fulldeps/tools.mk

# We're using the llvm-nm instead of the system nm to ensure it is compatible
# with the LLVM bitcode generated by rustc.
NM = "$(LLVM_BIN_DIR)"/llvm-nm

all: $(call NATIVE_STATICLIB,native_dep_1) $(call NATIVE_STATICLIB,native_dep_2) $(call NATIVE_STATICLIB,native_dep_3)
	# Build native libs
	# $(RUSTC) native_dep_1.rs --crate-type=staticlib
	# $(RUSTC) native_dep_2.rs --crate-type=staticlib
	# $(RUSTC) native_dep_3.rs --crate-type=staticlib
	$(NM) $(TMPDIR)/libnative_dep_1.a | $(CGREP) "T native_f1"
	$(NM) $(TMPDIR)/libnative_dep_2.a | $(CGREP) "T native_f2"
	$(NM) $(TMPDIR)/libnative_dep_3.a | $(CGREP) "T native_f3"

	# Build new rlibs
	$(RUSTC) rust_dep_up.rs --crate-type=rlib -Zseparate_native_rlib_dependencies
	$(NM) $(TMPDIR)/librust_dep_up.rlib | $(CGREP) "U native_f2"
	$(NM) $(TMPDIR)/librust_dep_up.rlib | $(CGREP) "U native_f3"
	$(NM) $(TMPDIR)/librust_dep_up.rlib | $(CGREP) -e "T.*rust_dep_up"
	ar t $(TMPDIR)/librust_dep_up.rlib | $(CGREP) "libnative_dep_2.a" # FIXME: crossplatform
	ar t $(TMPDIR)/librust_dep_up.rlib | $(CGREP) "libnative_dep_3.a" # FIXME: crossplatform
	$(RUSTC) rust_dep_local.rs --extern rlib=$(TMPDIR)/librust_dep_up.rlib -Zseparate_native_rlib_dependencies --crate-type=rlib -Z unstable-options
	$(NM) $(TMPDIR)/librust_dep_local.rlib | $(CGREP) "U native_f1"
	$(NM) $(TMPDIR)/librust_dep_local.rlib | $(CGREP) -e "T.*rust_dep_local"
	ar t $(TMPDIR)/librust_dep_local.rlib | $(CGREP) "libnative_dep_1.a" # FIXME: crossplatform

	# Build bin
	$(RUSTC) main.rs --extern lib=$(TMPDIR)/librust_dep_local.rlib --crate-type=bin -Zseparate_native_rlib_dependencies --print link-args | $(CGREP) -e 'native_dep_1.*native_dep_2.*native_dep_3'
	$(NM) $(TMPDIR)/main | $(CGREP) "T native_f1"
	$(NM) $(TMPDIR)/main | $(CGREP) "T native_f2"
	$(NM) $(TMPDIR)/main | $(CGREP) "T native_f3"
	$(NM) $(TMPDIR)/main | $(CGREP) -e "T.*rust_dep_local"
	$(NM) $(TMPDIR)/main | $(CGREP) -e "T.*rust_dep_up"

